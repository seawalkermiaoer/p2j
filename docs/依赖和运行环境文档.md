# 依赖和运行环境文档

## 项目依赖

### 核心依赖

#### Python版本要求
- **最低版本**: Python 3.8
- **推荐版本**: Python 3.9 或 3.10
- **测试版本**: Python 3.8, 3.9, 3.10, 3.11

#### 主要依赖包

| 包名 | 版本要求 | 用途说明 |
|------|----------|----------|
| streamlit | >=1.28,<2.0 | Web应用框架 |
| numpy | >=1.23,<3.0 | 数值计算 |
| matplotlib | >=3.6,<4.0 | 图形绘制 |

#### 可选依赖

| 包名 | 版本要求 | 用途说明 |
|------|----------|----------|
| pandas | >=1.5,<2.0 | 数据处理 |
| plotly | >=5.0,<6.0 | 交互式图表 |
| seaborn | >=0.11,<1.0 | 统计可视化 |
| scipy | >=1.9,<2.0 | 科学计算 |

### 完整依赖列表

#### requirements.txt
```
# 核心运行时依赖
streamlit>=1.28,<2.0
numpy>=1.23,<3.0
matplotlib>=3.6,<4.0

# 开发工具依赖（可选）
pytest>=7.0,<8.0
black>=22.0,<23.0
flake8>=5.0,<6.0
mypy>=0.991,<1.0

# 文档生成依赖（可选）
sphinx>=5.0,<6.0
sphinx-rtd-theme>=1.0,<2.0

# 性能优化依赖（可选）
numba>=0.56,<1.0
cython>=0.29,<1.0
```

#### requirements-dev.txt
```
# 开发环境依赖
-r requirements.txt

# 测试框架
pytest>=7.0,<8.0
pytest-cov>=4.0,<5.0
pytest-mock>=3.0,<4.0

# 代码质量
black>=22.0,<23.0
flake8>=5.0,<6.0
isort>=5.0,<6.0
mypy>=0.991,<1.0
pre-commit>=2.0,<3.0

# 调试工具
ipython>=8.0,<9.0
jupyter>=1.0,<2.0
```

## 运行环境

### 本地开发环境

#### 系统要求
- **操作系统**: Windows 10+, macOS 10.14+, Ubuntu 18.04+
- **内存**: 最少4GB，推荐8GB以上
- **存储**: 最少1GB可用空间
- **网络**: 需要互联网连接进行包安装

#### 环境配置步骤

##### 1. 创建虚拟环境
```bash
# 使用venv
python3 -m venv geometry-env
source geometry-env/bin/activate  # macOS/Linux
# geometry-env\Scripts\activate    # Windows

# 使用conda
conda create -n geometry-env python=3.9
conda activate geometry-env
```

##### 2. 安装依赖
```bash
# 安装核心依赖
pip install -r requirements.txt

# 安装开发依赖（可选）
pip install -r requirements-dev.txt
```

##### 3. 验证安装
```bash
# 验证Python版本
python --version

# 验证包安装
pip list

# 运行测试
python -c "import streamlit, numpy, matplotlib; print('All packages installed successfully')"
```

### 生产环境

#### Docker环境

##### 1. Docker配置
```dockerfile
# Dockerfile
FROM python:3.9-slim

# 设置工作目录
WORKDIR /app

# 复制依赖文件
COPY requirements.txt .

# 安装依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 设置环境变量
ENV PYTHONPATH=/app
ENV STREAMLIT_SERVER_PORT=8501
ENV STREAMLIT_SERVER_ADDRESS=0.0.0.0

# 暴露端口
EXPOSE 8501

# 启动命令
CMD ["streamlit", "run", "main.py"]
```

##### 2. Docker Compose配置
```yaml
# docker-compose.yml
version: '3.8'

services:
  geometry-app:
    build: .
    ports:
      - "8501:8501"
    environment:
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - PYTHONPATH=/app
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    restart: unless-stopped
    
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - geometry-app
```

#### 云服务平台

##### 1. Heroku部署
```yaml
# app.yaml
runtime: python39

env_variables:
  STREAMLIT_SERVER_PORT: $PORT
  STREAMLIT_SERVER_ADDRESS: 0.0.0.0

handlers:
- url: /.*
  script: auto
```

##### 2. AWS部署
```bash
# EC2用户数据脚本
#!/bin/bash
yum update -y
yum install -y python3 python3-pip

# 创建应用目录
mkdir -p /opt/geometry-app
cd /opt/geometry-app

# 复制代码
aws s3 cp s3://your-bucket/geometry-app.zip .
unzip geometry-app.zip

# 安装依赖
pip3 install -r requirements.txt

# 创建systemd服务
cat > /etc/systemd/system/geometry-app.service << EOF
[Unit]
Description=Geometry Learning Platform
After=network.target

[Service]
Type=simple
User=ec2-user
WorkingDirectory=/opt/geometry-app
ExecStart=/usr/bin/python3 -m streamlit run main.py --server.port=80 --server.address=0.0.0.0
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# 启动服务
systemctl enable geometry-app
systemctl start geometry-app
```

##### 3. Google Cloud部署
```yaml
# cloudbuild.yaml
steps:
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/geometry-app', '.']
  
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/geometry-app']
  
  - name: 'gcr.io/cloud-builders/gcloud'
    args: [
      'run', 'deploy', 'geometry-app',
      '--image', 'gcr.io/$PROJECT_ID/geometry-app',
      '--platform', 'managed',
      '--region', 'us-central1',
      '--allow-unauthenticated',
      '--port', '8501'
    ]
```

## 环境变量配置

### 开发环境变量
```bash
# .env.development
STREAMLIT_SERVER_PORT=8501
STREAMLIT_SERVER_ADDRESS=localhost
STREAMLIT_BROWSER_GATHER_USAGE_STATS=false
STREAMLIT_THEME_BASE=light
```

### 生产环境变量
```bash
# .env.production
STREAMLIT_SERVER_PORT=8501
STREAMLIT_SERVER_ADDRESS=0.0.0.0
STREAMLIT_BROWSER_GATHER_USAGE_STATS=false
STREAMLIT_SERVER_ENABLE_CORS=false
STREAMLIT_SERVER_ENABLE_XSRF_PROTECTION=true
```

### Streamlit配置
```toml
# .streamlit/config.toml
[server]
port = 8501
address = "0.0.0.0"
enableCORS = false
enableXsrfProtection = true

[browser]
gatherUsageStats = false

[theme]
base = "light"
primaryColor = "#FF4B4B"
backgroundColor = "#FFFFFF"
secondaryBackgroundColor = "#F0F2F6"
textColor = "#262730"
```

## 依赖冲突解决

### 常见冲突

#### 1. Streamlit与Matplotlib版本冲突
```bash
# 解决方案
pip install streamlit==1.28.2 matplotlib==3.7.2 --force-reinstall
```

#### 2. NumPy版本不兼容
```bash
# 解决方案
pip install numpy==1.24.3 --upgrade --force-reinstall
```

### 依赖锁定

#### 使用pip-tools
```bash
# 安装pip-tools
pip install pip-tools

# 生成锁定文件
pip-compile requirements.in
pip-compile requirements-dev.in

# 安装锁定版本
pip-sync requirements.txt requirements-dev.txt
```

#### 使用Poetry
```toml
# pyproject.toml
[tool.poetry]
name = "geometry-learning-platform"
version = "1.0.0"
description = "Interactive geometry learning platform"
authors = ["Your Name <your.email@example.com>"]

[tool.poetry.dependencies]
python = "^3.8"
streamlit = "^1.28"
numpy = "^1.23"
matplotlib = "^3.6"

[tool.poetry.dev-dependencies]
pytest = "^7.0"
black = "^22.0"
flake8 = "^5.0"

[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"
```

## 性能调优

### Python性能优化

#### 1. NumPy优化
```python
# 使用向量化操作
import numpy as np

# 避免循环
points = np.array([[x1, y1], [x2, y2], [x3, y3]])
areas = 0.5 * np.abs(np.cross(points[1] - points[0], points[2] - points[0]))
```

#### 2. Matplotlib优化
```python
# 减少内存使用
import matplotlib
matplotlib.use('Agg')  # 非交互式后端

# 清理图形
import gc
plt.clf()
plt.cla()
plt.close('all')
gc.collect()
```

### Streamlit优化

#### 1. 缓存策略
```python
import streamlit as st

@st.cache_data
def expensive_computation(a, b, c):
    """缓存计算结果。"""
    return complex_calculation(a, b, c)

@st.cache_resource
def get_matplotlib_figure():
    """缓存图形对象。"""
    return plt.figure(figsize=(10, 6))
```

#### 2. 延迟加载
```python
# 使用会话状态管理
if 'data_loaded' not in st.session_state:
    st.session_state.data_loaded = load_data()
```

## 测试环境

### 单元测试
```python
# tests/test_geometry.py
import pytest
import numpy as np
from src.geometry import calculate_triangle_area

class TestTriangleArea:
    def test_equilateral_triangle(self):
        area = calculate_triangle_area(3, 3, 3)
        expected = (np.sqrt(3) / 4) * 9
        assert abs(area - expected) < 1e-6
    
    def test_right_triangle(self):
        area = calculate_triangle_area(3, 4, 5)
        assert area == 6.0
    
    def test_invalid_triangle(self):
        with pytest.raises(ValueError):
            calculate_triangle_area(1, 2, 3)
```

### 集成测试
```python
# tests/test_streamlit.py
import subprocess
import time
import requests

def test_streamlit_app():
    """测试Streamlit应用。"""
    process = subprocess.Popen([
        'streamlit', 'run', 'main.py', 
        '--server.port=8501', 
        '--server.headless=true'
    ])
    
    time.sleep(5)  # 等待应用启动
    
    try:
        response = requests.get('http://localhost:8501')
        assert response.status_code == 200
    finally:
        process.terminate()
```

## 环境检查脚本

### 自动检查脚本
```bash
#!/bin/bash
# check_environment.sh

echo "=== 环境检查开始 ==="

# 检查Python版本
python_version=$(python3 --version 2>&1)
echo "Python版本: $python_version"

# 检查pip
if command -v pip3 &> /dev/null; then
    echo "✅ pip3 已安装"
else
    echo "❌ pip3 未安装"
    exit 1
fi

# 检查依赖
pip3 check

# 检查磁盘空间
disk_space=$(df -h . | awk 'NR==2 {print $4}')
echo "剩余磁盘空间: $disk_space"

# 检查内存
memory=$(free -h | awk 'NR==2{print $7}')
echo "可用内存: $memory"

echo "=== 环境检查完成 ==="
```

### Python环境检查
```python
# check_python.py
import sys
import importlib
import pkg_resources

def check_environment():
    """检查Python环境。"""
    print("=== Python环境检查 ===")
    
    # Python版本
    print(f"Python版本: {sys.version}")
    
    # 检查核心包
    required_packages = [
        'streamlit', 'numpy', 'matplotlib'
    ]
    
    for package in required_packages:
        try:
            version = pkg_resources.get_distribution(package).version
            print(f"✅ {package}: {version}")
        except pkg_resources.DistributionNotFound:
            print(f"❌ {package}: 未安装")
    
    print("=== 检查完成 ===")

if __name__ == "__main__":
    check_environment()
```

## 故障排除指南

### 常见问题

#### 1. 包安装失败
```bash
# 解决方案
pip install --upgrade pip setuptools wheel
pip install --no-cache-dir -r requirements.txt
```

#### 2. 内存不足
```bash
# 解决方案
export STREAMLIT_SERVER_MAX_UPLOAD_SIZE=100
python -m streamlit run main.py --server.maxUploadSize=100
```

#### 3. 端口冲突
```bash
# 检查端口占用
lsof -i :8501
# 使用不同端口
streamlit run main.py --server.port=8502
```

### 日志分析
```bash
# 查看Streamlit日志
tail -f ~/.streamlit/logs/*.log

# 查看系统日志
journalctl -u geometry-app -f
```

## 相关文档

- [技术架构和部署文档](技术架构和部署文档.md)
- [三角形分类页面实现文档](1_三角形分类_实现文档.md)
- [勾股定理页面实现文档](2_勾股定理_实现文档.md)
- [等高模型页面实现文档](3_等高模型_实现文档.md)
- [一半模型页面实现文档](4_一半模型_实现文档.md)
- [燕尾模型页面实现文档](5_燕尾模型_实现文档.md)

---

*文档创建时间：2024年*  
*最后更新：2024年*