# 技术架构和部署文档

## 项目概述

本项目是一个基于Streamlit的几何学习平台，专注于三角形相关知识的交互式学习。项目采用模块化设计，包含五个主要功能模块：三角形分类、勾股定理、等高模型、一半模型和燕尾模型。

## 技术架构

### 整体架构

```
几何学习平台
├── 前端层
│   ├── Streamlit应用框架
│   ├── 交互式可视化
│   └── 响应式界面
├── 业务逻辑层
│   ├── 几何计算引擎
│   ├── 图形渲染引擎
│   └── 数据验证模块
├── 数据层
│   ├── 数学算法库
│   ├── 图形配置数据
│   └── 用户交互数据
└── 基础设施层
    ├── Python运行时
    ├── 依赖管理
    └── 部署环境
```

### 技术栈

#### 核心技术
- **Python 3.8+**: 主要编程语言
- **Streamlit 1.28+**: Web应用框架
- **NumPy 1.23+**: 数值计算库
- **Matplotlib 3.6+**: 图形绘制库

#### 开发工具
- **Google Python Style Guide**: 代码规范
- **Git**: 版本控制
- **VS Code**: 开发环境
- **pip**: 包管理工具

### 模块架构

#### 1. 应用入口
```python
# main.py - 应用主入口
import streamlit as st
from utils.fonts import setup_custom_font
from pages import *

def main():
    """应用主函数。"""
    setup_custom_font()
    st.set_page_config(
        page_title="几何学习平台",
        page_icon="🔺",
        layout="wide"
    )
    
    # 页面路由
    pages = {
        "三角形分类": triangle_classification,
        "勾股定理": pythagorean_theorem,
        "等高模型": equal_height_model,
        "一半模型": half_model,
        "燕尾模型": yanwei_model
    }
    
    # 页面选择
    selected_page = st.sidebar.selectbox("选择功能", list(pages.keys()))
    pages[selected_page]()
```

#### 2. 字体管理模块
```python
# utils/fonts.py - 字体管理
import matplotlib.pyplot as plt
from pathlib import Path

def setup_custom_font(font_path: str = None) -> bool:
    """
    设置自定义字体。
    
    Args:
        font_path: 字体文件路径
    
    Returns:
        bool: 设置是否成功
    """
    try:
        if font_path and Path(font_path).exists():
            plt.rcParams['font.family'] = font_path
        else:
            plt.rcParams['font.family'] = ['SimHei', 'DejaVu Sans']
        return True
    except Exception as e:
        print(f"字体设置失败: {e}")
        return False
```

#### 3. 页面模块架构
每个页面模块遵循统一的架构模式：

```python
# 页面模块模板
import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from utils.fonts import setup_custom_font

def render_header():
    """渲染页面头部。"""
    st.title("页面标题")
    st.markdown("页面描述")

def render_controls():
    """渲染控制面板。"""
    st.sidebar.header("参数调整")
    # 参数控件

def render_visualization():
    """渲染可视化内容。"""
    # 图形绘制逻辑

def render_explanation():
    """渲染原理说明。"""
    # 数学原理展示

def main():
    """页面主函数。"""
    setup_custom_font()
    render_header()
    render_controls()
    render_visualization()
    render_explanation()

if __name__ == "__main__":
    main()
```

## 部署架构

### 开发环境

#### 本地开发
```bash
# 环境准备
python3 -m venv venv
source venv/bin/activate  # macOS/Linux
pip install -r requirements.txt

# 启动应用
streamlit run main.py
```

#### 开发工具配置
```json
// .vscode/settings.json
{
    "python.defaultInterpreterPath": "./venv/bin/python",
    "python.linting.enabled": true,
    "python.linting.pylintEnabled": true,
    "python.formatting.provider": "black",
    "editor.formatOnSave": true
}
```

### 生产环境

#### Docker部署
```dockerfile
# Dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8501

CMD ["streamlit", "run", "main.py", "--server.port=8501", "--server.address=0.0.0.0"]
```

#### Docker Compose配置
```yaml
# docker-compose.yml
version: '3.8'

services:
  geometry-app:
    build: .
    ports:
      - "8501:8501"
    environment:
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
    volumes:
      - ./data:/app/data
    restart: unless-stopped
```

#### 云服务部署

##### 1. Heroku部署
```yaml
# app.yaml (Heroku)
runtime: python3.9

build:
  docker:
    web: Dockerfile

run:
  web: streamlit run main.py --server.port=$PORT --server.address=0.0.0.0
```

##### 2. AWS EC2部署
```bash
# EC2部署脚本
#!/bin/bash
sudo apt-get update
sudo apt-get install -y python3-pip
pip3 install -r requirements.txt
nohup streamlit run main.py --server.port=80 --server.address=0.0.0.0 &
```

##### 3. Google Cloud Run
```yaml
# cloudbuild.yaml
steps:
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/geometry-app', '.']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/geometry-app']
  - name: 'gcr.io/cloud-builders/gcloud'
    args: ['run', 'deploy', 'geometry-app', '--image', 'gcr.io/$PROJECT_ID/geometry-app', '--platform', 'managed']
```

## 性能优化

### 计算优化

#### 1. 缓存策略
```python
# utils/cache.py
import functools
import streamlit as st

@st.cache_data
def calculate_triangle_area(a, b, c):
    """缓存三角形面积计算。"""
    s = (a + b + c) / 2
    return (s * (s - a) * (s - b) * (s - c)) ** 0.5

@st.cache_resource
def get_matplotlib_figure():
    """缓存图形对象。"""
    return plt.figure(figsize=(10, 6))
```

#### 2. 并行计算
```python
# utils/parallel.py
import concurrent.futures
import numpy as np

def batch_calculate_areas(triangles):
    """批量计算三角形面积。"""
    with concurrent.futures.ThreadPoolExecutor() as executor:
        results = executor.map(calculate_triangle_area, triangles)
    return list(results)
```

### 内存优化

#### 1. 图形内存管理
```python
# utils/memory.py
import gc
import matplotlib.pyplot as plt

def cleanup_matplotlib():
    """清理matplotlib内存。"""
    plt.clf()
    plt.cla()
    plt.close('all')
    gc.collect()
```

#### 2. 数据压缩
```python
# utils/compression.py
import numpy as np

def compress_coordinates(coords):
    """压缩坐标数据。"""
    return np.round(coords, decimals=2)
```

### 网络优化

#### 1. 静态资源优化
```python
# utils/assets.py
def optimize_image(image_path):
    """优化图像文件。"""
    # 使用PIL优化图像大小
    from PIL import Image
    with Image.open(image_path) as img:
        img.save(image_path, optimize=True, quality=85)
```

#### 2. CDN配置
```yaml
# streamlit_config.toml
[server]
enableCORS = false
enableXsrfProtection = false

[browser]
gatherUsageStats = false
```

## 监控和日志

### 应用监控

#### 1. 性能监控
```python
# utils/monitoring.py
import time
import streamlit as st

def monitor_performance(func):
    """性能监控装饰器。"""
    def wrapper(*args, **kwargs):
        start_time = time.time()
        result = func(*args, **kwargs)
        end_time = time.time()
        
        st.sidebar.text(f"{func.__name__}耗时: {end_time - start_time:.2f}s")
        return result
    return wrapper
```

#### 2. 错误监控
```python
# utils/error_handler.py
import streamlit as st
import traceback

def handle_exception(func):
    """异常处理装饰器。"""
    def wrapper(*args, **kwargs):
        try:
            return func(*args, **kwargs)
        except Exception as e:
            st.error(f"发生错误: {str(e)}")
            st.code(traceback.format_exc())
    return wrapper
```

### 日志配置
```python
# utils/logger.py
import logging
import streamlit as st

def setup_logger():
    """设置日志系统。"""
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        handlers=[
            logging.FileHandler('app.log'),
            logging.StreamHandler()
        ]
    )
    return logging.getLogger(__name__)
```

## 安全配置

### 输入验证
```python
# utils/validation.py
def validate_triangle_sides(a, b, c):
    """验证三角形边长。"""
    if a <= 0 or b <= 0 or c <= 0:
        raise ValueError("边长必须为正数")
    if a + b <= c or a + c <= b or b + c <= a:
        raise ValueError("不满足三角形不等式")
    return True
```

### 数据清理
```python
# utils/sanitization.py
def sanitize_input(value, min_val=0.1, max_val=1000):
    """清理用户输入。"""
    try:
        value = float(value)
        return max(min_val, min(max_val, value))
    except (ValueError, TypeError):
        return min_val
```

## 扩展和升级

### 功能扩展

#### 1. 新模块添加
```python
# 添加新模块模板
# pages/new_module.py
def new_module():
    """新模块实现。"""
    st.title("新模块")
    # 实现逻辑
```

#### 2. 插件系统
```python
# utils/plugin_system.py
class PluginManager:
    def __init__(self):
        self.plugins = {}
    
    def register_plugin(self, name, plugin):
        self.plugins[name] = plugin
    
    def get_plugin(self, name):
        return self.plugins.get(name)
```

### 技术升级路径

#### 1. 框架升级
- Streamlit 2.x 兼容性
- 支持新的可视化库
- 集成WebAssembly计算

#### 2. 性能升级
- 使用Dask进行分布式计算
- 集成GPU加速
- 实现服务端渲染

#### 3. 功能升级
- 支持3D可视化
- 添加AR/VR功能
- 实现协作学习

## 故障排除

### 常见问题

#### 1. 字体显示问题
```python
# 字体问题排查
import matplotlib.pyplot as plt
print(plt.rcParams['font.family'])
```

#### 2. 内存泄漏
```python
# 内存问题排查
import psutil
import os

def check_memory():
    process = psutil.Process(os.getpid())
    return process.memory_info().rss / 1024 / 1024  # MB
```

#### 3. 性能问题
```python
# 性能问题排查
import cProfile
import pstats

def profile_function(func):
    profiler = cProfile.Profile()
    profiler.enable()
    func()
    profiler.disable()
    
    stats = pstats.Stats(profiler)
    stats.sort_stats('cumulative')
    stats.print_stats()
```

## 部署检查清单

### 部署前检查
- [ ] 依赖包版本确认
- [ ] 环境变量配置
- [ ] 端口配置正确
- [ ] 日志系统配置
- [ ] 错误处理机制
- [ ] 性能监控启用
- [ ] 安全配置检查
- [ ] 备份策略制定

### 部署后验证
- [ ] 应用正常启动
- [ ] 所有功能测试
- [ ] 性能指标正常
- [ ] 日志文件生成
- [ ] 错误监控有效
- [ ] 用户访问正常
- [ ] 资源使用合理

## 相关文档

- [三角形分类页面实现文档](1_三角形分类_实现文档.md)
- [勾股定理页面实现文档](2_勾股定理_实现文档.md)
- [等高模型页面实现文档](3_等高模型_实现文档.md)
- [一半模型页面实现文档](4_一半模型_实现文档.md)
- [燕尾模型页面实现文档](5_燕尾模型_实现文档.md)

---

*文档创建时间：2024年*  
*最后更新：2024年*